name: Build PowerShell to EXE

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install PS2EXE module
      shell: pwsh
      run: |
        Set-PSRepository -Name PSGallery -InstallationPolicy Trusted -ErrorAction SilentlyContinue
        Install-Module -Name ps2exe -Force -AllowClobber -Scope CurrentUser -ErrorAction Stop
        Get-Module -ListAvailable ps2exe | Select Name, Version

    - name: Create output directory
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Path ".\dist" -Force | Out-Null
        Write-Host "Output directory created"

    - name: Compile PS1 to EXE (Console Version)
      shell: pwsh
      run: |
        $source = ".\show_and_bsod.ps1"
        $output = ".\dist\BSODShow.exe"
        
        Invoke-PS2EXE -inputFile $source -outputFile $output `
          -noConsole:$false `
          -noOutput:$false `
          -x64 `
          -requireAdmin:$false `
          -supportOS:$true
        
        Write-Host "Compiled console: $output"

    - name: Compile PS1 to EXE (GUI Version)
      shell: pwsh
      run: |
        $source = ".\show_and_bsod.ps1"
        $output = ".\dist\BSODShow_GUI.exe"
        
        Invoke-PS2EXE -inputFile $source -outputFile $output `
          -noConsole:$true `
          -noOutput:$true `
          -x64 `
          -title "BSOD Show" `
          -description "BSOD Show Application" `
          -company "Demo Corp" `
          -product "BSOD Show" `
          -copyright "2026" `
          -version "1.0.0.0"
        
        Write-Host "Compiled GUI: $output"

    - name: Upload Console EXE (separate artifact)
      uses: actions/upload-artifact@v4
      with:
        name: BSODShow-Console
        path: ./dist/BSODShow.exe
        retention-days: 7

    - name: Upload GUI EXE (separate artifact)
      uses: actions/upload-artifact@v4
      with:
        name: BSODShow-GUI
        path: ./dist/BSODShow_GUI.exe
        retention-days: 7

    - name: Upload All Dist (both EXEs in one zip)
      uses: actions/upload-artifact@v4
      with:
        name: BSODShow-All
        path: ./dist/*.exe
        retention-days: 7

    - name: Create release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: ./dist/*.exe
        body: |
          Автоматическая сборка BSOD Show ${{ github.ref_name }}
          
          Скачивай отдельно:
          - BSODShow.exe (консольная версия)
          - BSODShow_GUI.exe (без окна консоли)
